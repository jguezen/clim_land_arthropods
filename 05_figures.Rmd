---
title: "05. Figures"
author: Jessica Guezen
output: pdf_document
---

# Set up

Open csv:
```{r}
climate_land_abund = read.csv(
  "~/Desktop/clim_land_arthropods/final_dat.csv")
```

Load packages:
```{r}
library(arm)
library(lme4)
library(lmerTest)
library(MuMIn)
library(polypoly)
library(psych)
library(performance)
library(car)
library(tidyverse)
library(cowplot)
library(sf)
library(viridis)
library(ggeffects)
library(ggrepel)
library(ggmosaic)
library(ggimage)
```

```{r}
climate_land_abund <-
  climate_land_abund %>%
  dplyr::select(-X)
```

# Figure 1

```{r}
tf1a_dat <- data.frame(
  MAT = 2:5,
  SNH = c(25, 25, 25, 25, 50, 50, 50, 50, 75, 75, 75, 75, 100, 100, 100, 100))
tf1a_dat <- tf1a_dat %>%
  poly_add_columns(SNH, degree = 2, prefix = "SNH_") %>%
  mutate(
    abundance_1 = 3*SNH_1 + 12*SNH_2 + 9*MAT + 5,
    abundance_2 = 3*SNH_1 + 12*SNH_2 + 9*MAT + 6*(SNH_2*MAT) + 11,
    abundance_3 = 3*SNH_1 + 12*SNH_2 + 9*MAT - 6*(SNH_2*MAT) - 1,
         )
```

```{r fig.height=2.5, fig.width=4}
tf1a_dat_hull <- tf1a_dat %>%
  slice(chull(SNH, MAT))

tf1a_dat_hull <- tf1a_dat_hull %>%
  dplyr::select(SNH, MAT)
tf1a_dat_hull_sf <-
  tf1a_dat_hull %>% st_as_sf(coords = c("SNH", "MAT")) %>%
  summarise() %>%
  st_cast("POLYGON") %>%
  st_convex_hull()

tf1a_dat_xy <-
  with(tf1a_dat,
       expand.grid(
         SNH = seq(min(SNH),
                   max(SNH),
                   len = 400),
         MAT = seq(min(MAT),
                        max(MAT),
                        len = 400)
       ))

tf1a_dat_xy_sf = st_as_sf(tf1a_dat_xy,
                         coords = c("SNH", "MAT"))
plot_tf1a_crop <-
  st_intersection(
    tf1a_dat_xy_sf,
    tf1a_dat_hull_sf) %>%
  st_coordinates() %>%
  as.data.frame() %>%
  rename(SNH = X,
         MAT = Y)

plot_tf1a_crop <- plot_tf1a_crop %>%
  poly_add_columns(SNH, degree = 2, prefix = "SNH_")

mod1a <- lm(
  abundance_1 ~
    SNH_1 + SNH_2 + MAT,
  data = tf1a_dat
)

plot_tf1a_crop$abundance_1 <-
  c(predict(mod1a, newdata = plot_tf1a_crop, se = FALSE))

heatmap_tf1a <- ggplot() +
  geom_raster(data = plot_tf1a_crop,
              aes(x = SNH,
                  y = MAT,
                  fill = abundance_1)) +
  geom_contour(
    data = plot_tf1a_crop,
    aes(x = SNH,
        y = MAT,
        z = abundance_1),
    breaks = c(16, 20, 24, 28, 32, 36, 40, 44, 48, 52, 56, 60, 64, 68, 72, 76, 80),
    color = 'white',
    alpha = 0.5
  ) +
  scale_fill_viridis_c(
    option = "plasma",
    begin = 0,
    end = (58.01246-16.32918)/(79.01246-16.32918),
    alpha = 1
    ) +
  scale_x_continuous(
    breaks = c(26, 99),
    labels = c("low", "high")) +
  scale_y_continuous(
    breaks = c(2.1, 4.9),
    labels = c("low", "high")) +
  theme_classic() +
  theme(
    aspect.ratio = 1,
    # axis.title.x = element_blank(),
    legend.position = "none",
    # legend.title = element_blank(),
    legend.key.width = unit(0.25, "cm"),
    legend.key.height = unit(0.5, "cm"),
    legend.box.spacing = unit(0.25, "pt"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0,0,0,0), "cm")) +
  labs(
    title = "Additive",
    fill = "Abundance",
       x = "",
       y = "MAT (°C)")
heatmap_tf1a
```

```{r fig.height=2.5, fig.width=4}
tf1a_dat_hull <- tf1a_dat %>%
  slice(chull(SNH, MAT))

tf1a_dat_hull <- tf1a_dat_hull %>%
  dplyr::select(SNH, MAT)
tf1a_dat_hull_sf <-
  tf1a_dat_hull %>% st_as_sf(coords = c("SNH", "MAT")) %>%
  summarise() %>%
  st_cast("POLYGON") %>%
  st_convex_hull()

tf1a_dat_xy <-
  with(tf1a_dat,
       expand.grid(
         SNH = seq(min(SNH),
                   max(SNH),
                   len = 400),
         MAT = seq(min(MAT),
                        max(MAT),
                        len = 400)
       ))

tf1a_dat_xy_sf = st_as_sf(tf1a_dat_xy,
                         coords = c("SNH", "MAT"))
plot_tf1a_crop <-
  st_intersection(
    tf1a_dat_xy_sf,
    tf1a_dat_hull_sf) %>%
  st_coordinates() %>%
  as.data.frame() %>%
  rename(SNH = X,
         MAT = Y)

plot_tf1a_crop <- plot_tf1a_crop %>%
  poly_add_columns(SNH, degree = 2, prefix = "SNH_")

mod1a <- lm(
  abundance_3 ~
    SNH_1 + SNH_2*MAT,
  data = tf1a_dat
)

plot_tf1a_crop$abundance_3 <-
  c(predict(mod1a, newdata = plot_tf1a_crop, se = FALSE))

heatmap_tf1b <- ggplot() +
  geom_raster(data = plot_tf1a_crop,
              aes(x = SNH,
                  y = MAT,
                  fill = abundance_3)) +
  geom_contour(
    data = plot_tf1a_crop,
    aes(x = SNH,
        y = MAT,
        z = abundance_3),
    breaks = c(16, 20, 24, 28, 32, 36, 40, 44, 48, 52, 56, 60, 64, 68, 72, 76, 80),
    color = 'white',
    alpha = 0.5
  ) +
  scale_fill_viridis_c(
    option = "plasma",
    begin = 0,
    end = (37.01246-16.32918)/(79.01246-16.32918),
    alpha = 1
    ) +
  scale_x_continuous(
    breaks = c(26, 99),
    labels = c("low", "high")) +
  scale_y_continuous(
    breaks = c(2.1, 4.9),
    labels = c("low", "high")) +
  theme_classic() +
  theme(
    aspect.ratio = 1,
    axis.title.y = element_blank(),
    legend.position = "none",
    # legend.title = element_blank(),
    legend.key.width = unit(0.25, "cm"),
    legend.key.height = unit(0.5, "cm"),
    legend.box.spacing = unit(0.25, "pt"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0,0,0,0), "cm")) +
  labs(
    title = "Antagonistic",
    fill = "Abundance",
       x = "SNH (%)",
       y = "MAT (°C)")
heatmap_tf1b
```

```{r fig.height=2.5, fig.width=4}
tf1a_dat_hull <- tf1a_dat %>%
  slice(chull(SNH, MAT))

tf1a_dat_hull <- tf1a_dat_hull %>%
  dplyr::select(SNH, MAT)
tf1a_dat_hull_sf <-
  tf1a_dat_hull %>% st_as_sf(coords = c("SNH", "MAT")) %>%
  summarise() %>%
  st_cast("POLYGON") %>%
  st_convex_hull()

tf1a_dat_xy <-
  with(tf1a_dat,
       expand.grid(
         SNH = seq(min(SNH),
                   max(SNH),
                   len = 400),
         MAT = seq(min(MAT),
                        max(MAT),
                        len = 400)
       ))

tf1a_dat_xy_sf = st_as_sf(tf1a_dat_xy,
                         coords = c("SNH", "MAT"))
plot_tf1a_crop <-
  st_intersection(
    tf1a_dat_xy_sf,
    tf1a_dat_hull_sf) %>%
  st_coordinates() %>%
  as.data.frame() %>%
  rename(SNH = X,
         MAT = Y)

plot_tf1a_crop <- plot_tf1a_crop %>%
  poly_add_columns(SNH, degree = 2, prefix = "SNH_")

mod1a <- lm(
  abundance_2 ~
    SNH_1 + SNH_2*MAT,
  data = tf1a_dat
)

plot_tf1a_crop$abundance_2 <-
  c(predict(mod1a, newdata = plot_tf1a_crop, se = FALSE))

heatmap_tf1c <- ggplot() +
  geom_raster(data = plot_tf1a_crop,
              aes(x = SNH,
                  y = MAT,
                  fill = abundance_2)) +
  geom_contour(
    data = plot_tf1a_crop,
    aes(x = SNH,
        y = MAT,
        z = abundance_2),
    breaks = c(16, 20, 24, 28, 32, 36, 40, 44, 48, 52, 56, 60, 64, 68, 72, 76, 80),
    color = 'white',
    alpha = 0.5
  ) +
  scale_fill_viridis_c(
    option = "plasma",
    begin = 0,
    end = 1,
    alpha = 1,
    breaks = c(29, 60),
    labels = c("low", "high")
    ) +
  scale_x_continuous(
    breaks = c(26, 99),
    labels = c("low", "high")) +
  scale_y_continuous(
    breaks = c(2.1, 4.9),
    labels = c("low", "high")) +
  theme_classic() +
  theme(
    aspect.ratio = 1,
    axis.title.y = element_blank(),
    legend.position = "right",
    legend.key.width = unit(0.25, "cm"),
    legend.key.height = unit(0.25, "cm"),
    legend.box.spacing = unit(0.25, "pt"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0,0,0,0), "cm")) +
  labs(
    title = "Synergistic",
    fill = "Abundance",
       x = "",
       y = "MAT (°C)")
heatmap_tf1c
```

# Figure 3

```{r}
Trait_syndromes_bar <- data.frame(
  count_pollinator = c(0, 0, 0, 0, 0, 0, 777, 0, 0, 0, 193, 0, 0, 0, 323, 0),
  count_pest = c(0, 0, 1, 0, 0, 0, 15, 0, 0, 209, 0, 0, 0, 225, 9, 0),
  count_nat_enemy = c(119, 0, 496, 519, 275, 0, 295, 349, 0, 0, 198, 0, 81, 134, 2, 14),
  diet_breadth = c("diet generalist",
                   "diet generalist",
                   "diet generalist",
                   "diet generalist",
                   "diet generalist",
                   "diet generalist",
                   "diet generalist",
                   "diet generalist",
                   "diet specialist",
                   "diet specialist",
                   "diet specialist",
                   "diet specialist",
                   "diet specialist",
                   "diet specialist",
                   "diet specialist",
                   "diet specialist"),
  habitat_breadth = c("generalist",
                      "generalist",
                      "generalist",
                      "generalist",
                      "specialist",
                      "specialist",
                      "specialist",
                      "specialist",
                      "generalist",
                      "generalist",
                      "generalist",
                      "generalist",
                      "specialist",
                      "specialist",
                      "specialist",
                      "specialist"),
  dispersal_mode = c("wind", "flight/wind", "flight", "ground", "wind", "flight/wind", "flight", "ground", "wind", "flight/wind", "flight", "ground", "wind", "flight/wind", "flight", "ground")
)

Trait_syndromes_bar <-
  Trait_syndromes_bar %>%
  mutate(
    percent_pollinator =
      (count_pollinator/1088)*100,
    percent_pest =
      (count_pest/894)*100,
    percent_nat_enemy =
      (count_nat_enemy/1703)*100
  )

Trait_syndromes_bar_pollinator <-
  Trait_syndromes_bar %>%
  filter(!count_pollinator == 0)
Trait_syndromes_bar_pest <-
    Trait_syndromes_bar %>%
  filter(!count_pest == 0)
Trait_syndromes_bar_nat_enemy <-
    Trait_syndromes_bar %>%
  filter(!count_nat_enemy == 0)
```


```{r}
Bar_pollinator <- ggplot(
  data = Trait_syndromes_bar,
  aes(x = habitat_breadth,
      y = percent_pollinator,
      fill = dispersal_mode)) +
  geom_bar(stat = "identity",
           position =
             position_dodge(preserve = "single"),
           colour = "black") +
  facet_grid(~diet_breadth, drop = F
             ) +
  labs(title = "a. Pollinators",
       fill = "Dispersal",
       y = "") +
  scale_fill_manual(values = c(
    "#f0f921",
    "#ed7953",
    "#9c179e",
    "#0d0887"
    ),
                    drop = F) +
  scale_y_continuous(breaks = c(0, 30, 60, 90),
                     labels = c("0", "30", "60", "90")) +
  scale_x_discrete(labels =
                     c("habitat\ngeneralist",
                     "habitat\nspecialist")) +
  theme_classic() +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.text.y = element_text(size = 9,
                               colour = "black"),
    axis.text.x = element_blank(),
    plot.title = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    panel.grid = element_blank(),
    # strip.background = element_blank(),
    strip.text = element_text(size = 9,
                               colour = "black"),
    plot.margin = unit(c(0,0,0,0), "cm")
  )
Bar_pollinator
```

```{r}
Bar_pest <- ggplot(
  data = Trait_syndromes_bar,
  aes(x = habitat_breadth,
      y = percent_pest,
      fill = dispersal_mode)) +
  geom_bar(stat = "identity",
           position = position_dodge(preserve = "single"), colour = "black") +
  facet_grid(~diet_breadth, drop = F
             ) +
  labs(title = "a. pests",
       fill = "Dispersal",
       y = "") +
  scale_fill_manual(values = c(
    "#f0f921",
    "#ed7953",
    "#9c179e",
    "#0d0887"
    ),
                    drop = F) +
  scale_y_continuous(breaks = c(0, 10, 20, 30),
                     labels = c("0", "10", "20", "30")) +
  scale_x_discrete(labels =
                     c("habitat\ngeneralist",
                     "habitat\nspecialist")) +
  theme_classic() +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.text.y = element_text(size = 9,
                               colour = "black"),
    axis.text.x = element_blank(),
    plot.title = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_blank(),
    plot.margin = unit(c(0,0,0,0), "cm")
  )
Bar_pest
```

```{r}
Bar_nat_enemy <- ggplot(
  data = Trait_syndromes_bar,
  aes(x = habitat_breadth,
      y = percent_nat_enemy,
      fill = dispersal_mode)) +
  geom_bar(stat = "identity",
           position = position_dodge(
             preserve = "single"),
           colour = "black") +
  facet_grid(~diet_breadth, drop = F
             ) +
  labs(title = "c. nat_enemys",
       fill = "Dispersal",
       y = ""
       ) +
  scale_fill_manual(values = c(
    "#f0f921",
    "#ed7953",
    "#9c179e",
    "#0d0887"),
                    drop = F) +
  scale_y_continuous(breaks = c(0, 15, 30),
                     labels = c("0", "15", "30")) +
  scale_x_discrete(labels =
                     c("habitat\ngeneralist",
                     "habitat\nspecialist")) +
  theme_classic() +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.text.y = element_text(size = 9,
                               colour = "black"),
    axis.text.x = element_text(size = 9,
                               colour = "black"),
    plot.title = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_blank(),
    plot.margin = unit(c(0,0,0,0), "cm")
  )
Bar_nat_enemy
```


```{r}
Bar_legend <- ggplot(
  data = Trait_syndromes_bar,
  aes(x = habitat_breadth,
      y = percent_nat_enemy,
      fill = dispersal_mode)) +
  geom_bar(stat = "identity",
           position = position_dodge(0.9), colour = "black") +
  facet_grid(~diet_breadth) +
  labs(title = "c. Natural enemies",
       fill = "Dispersal",
       x = "Habitat",
       y = "% of sampling locations where present") +
  scale_fill_manual(values = c(
    "#f0f921",
    "#ed7953",
    "#9c179e",
    "#0d0887"),
                    drop = F) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_classic() +
  guides(fill = guide_legend(reverse = F)) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(size = 10),
    legend.title = element_text(size = 10),
    strip.background = element_blank(),
    strip.text = element_text(size = 9,
                               colour = "black",
                              hjust = 0)
  )
Bar_legend
```

# Figure 4

```{r}
citable_02 <- read.csv("~/Desktop/clim_land_arthropods/citable_02.csv")
citable_03 <- read.csv("~/Desktop/clim_land_arthropods/citable_03.csv")
citable_06 <- read.csv("~/Desktop/clim_land_arthropods/citable_06.csv")
citable_08 <- read.csv("~/Desktop/clim_land_arthropods/citable_08.csv")
```

## Formatting

```{r}
citable_02 <- citable_02 %>%
  mutate(
    fg_ts = "02"
  )
citable_03 <- citable_03 %>%
  mutate(
    fg_ts = "03"
  )
citable_06 <- citable_06 %>%
  mutate(
    fg_ts = "06"
  )
citable_08 <- citable_08 %>%
  mutate(
    fg_ts = "08"
  )
ci_graphic <- rbind(
  citable_02,
  citable_03,
  citable_06,
  citable_08
)
```

```{r}
ci_graphic <- ci_graphic %>%
  pivot_longer(
    cols = ends_with("_2.5"),
    names_to = c("spatial_scale"),
    names_pattern = "CI_(.*)_2.5",
    values_to = "CI_2.5"
  ) %>%
  mutate(
    CI_97.5 = case_when(
      spatial_scale == 100 ~ CI_100_97.5,
      spatial_scale == 250 ~ CI_250_97.5,
      spatial_scale == 500 ~ CI_500_97.5
    )
  ) %>%
  dplyr::select(-CI_100_97.5,
                -CI_250_97.5,
                -CI_500_97.5) %>%
  mutate(
    significant = case_when(
      CI_2.5 > 0 & CI_97.5 > 0 |
        CI_2.5 < 0 & CI_97.5 < 0 ~ "yes",
      CI_2.5 <= 0 & CI_97.5 >= 0 |
        CI_2.5 >= 0 & CI_97.5 <= 0 ~ "no",
      .default = NA
    )
  )
ci_graphic$spatial_scale <-
  factor(ci_graphic$spatial_scale,
         ordered = T,
         levels = c("500", 
                    "250", 
                    "100"))
```

```{r}
level_order <- c(
  "TAP:maxT^2",
  "TAP:minT^2",
  "TAP:MAT^2",
  "TAP:edge^2",
  "TAP:SNH^2",
  "TAP:arable^2",
  "maxT^2:TAP",
  "maxT:TAP^2",
  "maxT:TAP",
  "maxT:edge^2",
  "maxT:SNH^2",
  "maxT:arable^2",
  "minT^2:TAP",
  "minT:TAP^2",
  "minT:TAP",
  "minT:edge^2",
  "minT:SNH^2",
  "minT:arable^2",
  "MAT^2:TAP",
  "MAT:TAP^2",
  "MAT:TAP",
  "MAT:edge^2",
  "MAT:SNH^2",
  "MAT:arable^2",
  "edge:TAP^2",
  "edge^2:TAP",
  "edge:TAP",
  "edge:maxT^2",
  "edge:maxT",
  "edge:minT^2",
  "edge:minT",
  "edge:MAT^2",
  "edge:MAT",
  "edge:SNH^2",
  "edge:arable^2",
  "SNH^2:TAP",
  "SNH:TAP^2",
  "SNH:TAP",
  "SNH^2:maxT",
  "SNH:maxT^2",
  "SNH:maxT",
  "SNH^2:minT",
  "SNH:minT^2",
  "SNH:minT",
  "SNH^2:MAT",
  "SNH:MAT^2",
  "SNH:MAT",
  "SNH^2:edge",
  "SNH:edge^2",
  "SNH:edge",
  "arable:TAP^2",
  "arable:TAP",
  "arable:maxT^2",
  "arable:maxT",
  "arable:minT^2",
  "arable:minT",
  "arable:MAT^2",
  "arable:MAT",
  "arable:edge^2",
  "arable:edge",
  "TAP^2",
  "TAP",
  "maxT^2",
  "maxT",
  "minT^2",
  "minT",
  "MAT^2",
  "MAT",
  "edge^2",
  "edge",
  "SNH^2",
  "SNH",
  "arable^2",
  "arable"
)
```

```{r}
ci_graphic <- ci_graphic %>%
  rowwise() %>%
  mutate(
    effect_size = median(c(CI_2.5,CI_97.5))) %>%
  ungroup()
```

## Pollinators

```{r}
ci_02_int_9.1 <- subset(ci_graphic, fg_ts == "02" & model == "modint_9.1")
ci_02_int_9.2 <- subset(ci_graphic, fg_ts == "02" & model == "modint_9.2")
```

plot_02_int_9.1:
```{r}
plot_02_int_9.1 <-
  ggplot(data = ci_02_int_9.1, aes(
    y = factor(term,
               level = level_order),
    alpha = spatial_scale,
    colour = factor(significant)
  )) +
  geom_vline(
    aes(xintercept = 0),
    colour = "black",
    linetype = "dashed",
    linewidth = 0.2
  ) +
  geom_errorbarh(aes(xmin = CI_2.5, 
                     xmax = CI_97.5),
                 position = position_dodge(width = 0.6),
                 linewidth = 0.3,
                 height = 0) +
  theme_classic() +
  theme(
    aspect.ratio = 1.4,
    axis.title.y = element_blank(),
    axis.text.y = element_text(
     face = c('plain'),
      colour = c("black")),
    legend.position = "none",
    plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm")
  ) +
  scale_alpha_manual(values = c(1, 1, 1, 1, 1, 1)) +
  scale_color_manual(values = c("gray80", "#0d0887")) +
  labs(x = "95% CI") +
  guides(alpha = guide_legend(reverse = TRUE,
                              title = "Spatial scale (m)"))
plot_02_int_9.1
```

plot_02_int_9.2:
```{r}
plot_02_int_9.2 <-
  ggplot(data = ci_02_int_9.2, aes(
    y = factor(term,
               level = level_order),
    alpha = spatial_scale,
    colour = factor(significant)
  )) +
  geom_vline(
    aes(xintercept = 0),
    colour = "black",
    linetype = "dashed",
    linewidth = 0.2
  ) +
  geom_errorbarh(aes(xmin = CI_2.5, 
                     xmax = CI_97.5),
                 position = position_dodge(width = 0.6),
                 linewidth = 0.3,
                 height = 0) +
  theme_classic() +
  theme(
    aspect.ratio = 1.4,
    axis.title.y = element_blank(),
    axis.text.y = element_text(
     face = c('plain'),
      colour = c("black")),
    legend.position = "none",
    plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm")
  ) +
  scale_alpha_manual(values = c(1, 1, 1, 1, 1, 1)) +
  scale_color_manual(values = c("gray80", "#0d0887")) +
  labs(x = "95% CI") +
  guides(alpha = guide_legend(reverse = TRUE,
                              title = "Spatial scale (m)"))
plot_02_int_9.2
```

## Pests

```{r}
ci_03_add_4 <- subset(ci_graphic, fg_ts == "03" & model == "modadd_4")
```

plot_03_add_4:
```{r}
plot_03_add_4 <-
  ggplot(data = ci_03_add_4, aes(
    y = factor(term,
               level = level_order),
    alpha = spatial_scale,
    colour = factor(significant)
  )) +
  geom_vline(
    aes(xintercept = 0),
    colour = "black",
    linetype = "dashed",
    linewidth = 0.2
  ) +
  geom_errorbarh(aes(xmin = CI_2.5, 
                     xmax = CI_97.5),
                 position = position_dodge(width = 0.6),
                 linewidth = 0.3,
                 height = 0) +
  theme_classic() +
  theme(
    aspect.ratio = 1.4,
    axis.title.y = element_blank(),
    axis.text.y = element_text(
     face = c('plain'),
      colour = c("black")),
    legend.position = "none",
    plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm")
  ) +
  scale_alpha_manual(values = c(1, 1, 1, 1, 1, 1)) +
  scale_color_manual(values = c("gray80", "#0d0887")) +
  labs(x = "95% CI") +
  guides(alpha = guide_legend(reverse = TRUE,
                              title = "Spatial scale (m)"))
plot_03_add_4
```

## Diet specialist pollinators

```{r}
ci_06_int_3.1 <- subset(ci_graphic, fg_ts == "06" & model == "modint_3.1")
ci_06_int_7.1 <- subset(ci_graphic, fg_ts == "06" & model == "modint_7.1")
ci_06_int_7.2 <- subset(ci_graphic, fg_ts == "06" & model == "modint_7.2")
ci_06_int_7.3 <- subset(ci_graphic, fg_ts == "06" & model == "modint_7.3")
```

plot_06_int_3.1:
```{r}
plot_06_int_3.1 <-
  ggplot(data = ci_06_int_3.1, aes(
    y = factor(term,
               level = level_order),
    alpha = spatial_scale,
    colour = factor(significant)
  )) +
  geom_vline(
    aes(xintercept = 0),
    colour = "black",
    linetype = "dashed",
    linewidth = 0.2
  ) +
  geom_errorbarh(aes(xmin = CI_2.5, 
                     xmax = CI_97.5),
                 position = position_dodge(width = 0.6),
                 linewidth = 0.3,
                 height = 0) +
  theme_classic() +
  theme(
    aspect.ratio = 1.4,
    axis.title.y = element_blank(),
    axis.text.y = element_text(
     face = c('plain'),
      colour = c("black")),
    legend.position = "none",
    plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm")
  ) +
  scale_alpha_manual(values = c(1, 1, 1, 1, 1, 1)) +
  scale_color_manual(values = c("gray80", "#0d0887")) +
  labs(x = "95% CI") +
  guides(alpha = guide_legend(reverse = TRUE,
                              title = "Spatial scale (m)"))
plot_06_int_3.1
```

plot_06_int_7.1:
```{r}
plot_06_int_7.1 <-
  ggplot(data = ci_06_int_7.1, aes(
    y = factor(term,
               level = level_order
               ),
    alpha = spatial_scale,
    colour = factor(significant)
  )) +
  geom_vline(
    aes(xintercept = 0),
    colour = "black",
    linetype = "dashed",
    linewidth = 0.2
  ) +
  geom_errorbarh(aes(xmin = CI_2.5, 
                     xmax = CI_97.5),
                 position = position_dodge(width = 0.6),
                 linewidth = 0.3,
                 height = 0) +
  theme_classic() +
  theme(
    aspect.ratio = 1.4,
    axis.title.y = element_blank(),
    axis.text.y = element_text(
     face = c('plain'),
      colour = c("black")),
    legend.position = "none",
    plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm")
  ) +
  scale_alpha_manual(values = c(1, 1, 1, 1, 1, 1)) +
  scale_color_manual(values = c("gray80", "#0d0887")) +
  labs(x = "95% CI") +
  guides(alpha = guide_legend(reverse = TRUE,
                              title = "Spatial scale (m)"))
plot_06_int_7.1
```

plot_06_int_7.2:
```{r}
plot_06_int_7.2 <-
  ggplot(data = ci_06_int_7.2, aes(
    y = factor(term,
               level = level_order
               ),
    alpha = spatial_scale,
    colour = factor(significant)
  )) +
  geom_vline(
    aes(xintercept = 0),
    colour = "black",
    linetype = "dashed",
    linewidth = 0.2
  ) +
  geom_errorbarh(aes(xmin = CI_2.5, 
                     xmax = CI_97.5),
                 position = position_dodge(width = 0.6),
                 linewidth = 0.3,
                 height = 0) +
  theme_classic() +
  theme(
    aspect.ratio = 1.4,
    axis.title.y = element_blank(),
    axis.text.y = element_text(
     face = c('plain'),
      colour = c("black")),
    legend.position = "none",
    plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm")
  ) +
  scale_alpha_manual(values = c(1, 1, 1, 1, 1, 1)) +
  scale_color_manual(values = c("gray80", "#0d0887")) +
  labs(x = "95% CI") +
  guides(alpha = guide_legend(reverse = TRUE,
                              title = "Spatial scale (m)"))
plot_06_int_7.2
```

plot_06_int_7.3:
```{r}
plot_06_int_7.3 <-
  ggplot(data = ci_06_int_7.3, aes(
    y = factor(term,
               level = level_order
               ),
    alpha = spatial_scale,
    colour = factor(significant)
  )) +
  geom_vline(
    aes(xintercept = 0),
    colour = "black",
    linetype = "dashed",
    linewidth = 0.2
  ) +
  geom_errorbarh(aes(xmin = CI_2.5, 
                     xmax = CI_97.5),
                 position = position_dodge(width = 0.6),
                 linewidth = 0.3,
                 height = 0) +
  theme_classic() +
  theme(
    aspect.ratio = 1.4,
    axis.title.y = element_blank(),
    axis.text.y = element_text(
     face = c('plain'),
      colour = c("black")),
    legend.position = "none",
    plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm")
  ) +
  scale_alpha_manual(values = c(1, 1, 1, 1, 1, 1)) +
  scale_color_manual(values = c("gray80", "#0d0887")) +
  labs(x = "95% CI") +
  guides(alpha = guide_legend(reverse = TRUE,
                              title = "Spatial scale (m)"))
plot_06_int_7.3
```

## Habitat specialist pest

```{r}
ci_08_int_5.3 <- subset(ci_graphic, fg_ts == "08" & model == "modint_5.3")
```

plot_08_int_5.3:
```{r}
plot_08_int_5.3 <-
  ggplot(data = ci_08_int_5.3, aes(
    y = factor(term,
               level = level_order),
    alpha = spatial_scale,
    colour = factor(significant)
  )) +
  geom_vline(
    aes(xintercept = 0),
    colour = "black",
    linetype = "dashed",
    linewidth = 0.2
  ) +
  geom_errorbarh(aes(xmin = CI_2.5, 
                     xmax = CI_97.5),
                 position = position_dodge(width = 0.6),
                 linewidth = 0.3,
                 height = 0) +
  theme_classic() +
  theme(
    aspect.ratio = 1.4,
    axis.title.y = element_blank(),
    axis.text.y = element_text(
     face = c('plain'),
      colour = c("black")),
    legend.position = "none",
    plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm")
  ) +
  scale_alpha_manual(values = c(1, 1, 1, 1, 1, 1)) +
  scale_color_manual(values = c("gray80", "#0d0887")) +
  labs(x = "95% CI") +
  guides(alpha = guide_legend(reverse = TRUE,
                              title = "Spatial scale (m)"))
plot_08_int_5.3
```

# Figure 5

## Pollinators

Data frame:
```{r}
climate_land_abund_02_500 <-
  climate_land_abund %>%
  filter(Pollinator_study == 1) %>%
  dplyr::select(
    fg_pollinator_abund_scaled,
    semi_500,
    edge_500,
    arable_500,
    TAP,
    MAT,
    min_temp,
    max_temp,
    StudyID_yr,
    Sampling_method,
    Block,
    Latitude,
    Longitude
  ) %>%
  ungroup() %>%
  na.omit() %>%
  poly_add_columns(semi_500, degree = 2, prefix = "semi_") %>%
  poly_add_columns(edge_500, degree = 2, prefix = "edge_") %>%
  poly_add_columns(arable_500, degree = 2, prefix = "arable_") %>%
  poly_add_columns(TAP, degree = 2, prefix = "TAP_") %>%
  poly_add_columns(MAT, degree = 2, prefix = "MAT_") %>%
  poly_add_columns(min_temp, degree = 2, prefix = "min_temp_") %>%
  poly_add_columns(max_temp, degree = 2, prefix = "max_temp_") %>%
  mutate(
    fg_02_l = log1p(fg_pollinator_abund_scaled),
    semi_1_l = log1p(semi_1),
    semi_2_l = log1p(semi_2),
    edge_1_l = log1p(edge_1),
    edge_2_l = log1p(edge_2),
    arable_1_l = log1p(arable_1),
    arable_2_l = log1p(arable_2),
    TAP_1_l = log1p(TAP_1),
    TAP_2_l = log1p(TAP_2),
    MAT_1_l = log1p(MAT_1),
    MAT_2_l = log1p(MAT_2),
    min_temp_1_l = log1p(min_temp_1),
    min_temp_2_l = log1p(min_temp_2),
    max_temp_1_l = log1p(max_temp_1),
    max_temp_2_l = log1p(max_temp_2)
  )
```

### heatmap_02

```{r}
climate_land_abund_02_500 <- climate_land_abund_02_500 %>%
  mutate(
    semi_500_l = log1p(semi_500),
    TAP_l = log1p(TAP)
  )

plot_02_500_dat_hull <- climate_land_abund_02_500 %>%
  slice(chull(semi_500_l, TAP_l))

plot_02_500_dat_hull <- plot_02_500_dat_hull %>%
  dplyr::select(semi_500_l, TAP_l)

plot_02_500_dat_hull_sf <- plot_02_500_dat_hull %>%
  st_as_sf(coords = c("semi_500_l", "TAP_l")) %>%
  summarise() %>%
  st_cast("POLYGON") %>%
  st_convex_hull()

plot_02_500_dat_xy <-
  with(climate_land_abund_02_500,
       expand.grid(
         semi_500_l = seq(min(semi_500_l),
                        max(semi_500_l),
                        len = 400),
         TAP_l = seq(min(TAP_l),
                        max(TAP_l),
                        len = 400)
       ))

plot_02_500_dat_xy_sf = st_as_sf(
  plot_02_500_dat_xy,
  coords = c("semi_500_l", "TAP_l"))

plot_02_crop <-
  st_intersection(
    plot_02_500_dat_xy_sf,
    plot_02_500_dat_hull_sf) %>%
  st_coordinates() %>%
  as.data.frame() %>%
  rename(semi_500_l = X, TAP_l = Y)

plot_02_crop <- plot_02_crop %>%
  mutate(
    semi_500 = (expm1(semi_500_l)),
    TAP = (expm1(TAP_l))
  ) %>%
  poly_add_columns(semi_500, degree = 2, prefix = "semi_") %>%
  poly_add_columns(TAP, degree = 2, prefix = "TAP_") %>%
  mutate(
    semi_1_l = log1p(semi_1),
    semi_2_l = log1p(semi_2),
    TAP_1_l = log1p(TAP_1),
    TAP_2_l = log1p(TAP_2)
  )

mod_02 <- lmer(
  fg_02_l ~
    semi_2_l * TAP_1_l +
    semi_1_l + TAP_1_l +
    semi_2_l + TAP_2_l +
    (1 | StudyID_yr) +
    (1 | StudyID_yr:Sampling_method:Block),
  data = climate_land_abund_02_500
)

plot_02_crop$fg_02_l <-
  c(predict(mod_02, newdata = plot_02_crop, se = F, re.form = NA))

heatmap_02 <- ggplot() +
  geom_raster(data = plot_02_crop,
              aes(x = semi_500_l,
                  y = TAP_l,
                  fill = fg_02_l)) +
  geom_contour(
    data = plot_02_crop,
    aes(x = semi_500_l,
        y = TAP_l,
        z = fg_02_l),
    color = 'white',
    alpha = 0.5
  ) +
  scale_fill_viridis_c(
    option = "plasma",
    alpha = 1,
    breaks = c(2.7, 3.0, 3.3, 3.6)
    ) +
  scale_y_continuous(
    breaks = c(log1p(500), log1p(1000), log1p(2000), log1p(3000)),
    labels = c(500, 1000, 2000, 3000)
    ) +
  scale_x_continuous(
    breaks = c(log1p(0), log1p(2), log1p(10), log1p(30), log1p(80)),
    labels = c(0, 2, 10, 30, 80)
    ) +
  theme_classic() +
  theme(
    aspect.ratio = 1,
    # plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    legend.text = element_text(size = 7),
    legend.position = "right",
    legend.title = element_blank(),
    legend.key.width = unit(0.25, "cm"),
    legend.key.height = unit(0.25, "cm"),
    legend.box.spacing = unit(0.25, "pt"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0,0,0,0), "cm")
  ) +
  labs(
    fill = "Abundance",
       x = "SNH (%) in 0.5 km",
       y = "TAP (cm)")
heatmap_02
```

## Pests

Data frame:
```{r}
climate_land_abund_03_500 <-
  climate_land_abund %>%
  filter(Pest_study == 1) %>%
  dplyr::select(
    fg_pest_abund_scaled,
    semi_500,
    edge_500,
    arable_500,
    TAP,
    MAT,
    min_temp,
    max_temp,
    StudyID_yr,
    Sampling_method,
    Block,
    Latitude,
    Longitude
  ) %>%
  ungroup() %>%
  na.omit() %>%
  poly_add_columns(semi_500, degree = 2, prefix = "semi_") %>%
  poly_add_columns(edge_500, degree = 2, prefix = "edge_") %>%
  poly_add_columns(arable_500, degree = 2, prefix = "arable_") %>%
  poly_add_columns(TAP, degree = 2, prefix = "TAP_") %>%
  poly_add_columns(MAT, degree = 2, prefix = "MAT_") %>%
  poly_add_columns(min_temp, degree = 2, prefix = "min_temp_") %>%
  poly_add_columns(max_temp, degree = 2, prefix = "max_temp_") %>%
  mutate(
    fg_03_l = log1p(fg_pest_abund_scaled),
    semi_1_l = log1p(semi_1),
    semi_2_l = log1p(semi_2),
    edge_1_l = log1p(edge_1),
    edge_2_l = log1p(edge_2),
    arable_1_l = log1p(arable_1),
    arable_2_l = log1p(arable_2),
    TAP_1_l = log1p(TAP_1),
    TAP_2_l = log1p(TAP_2),
    MAT_1_l = log1p(MAT_1),
    MAT_2_l = log1p(MAT_2),
    min_temp_1_l = log1p(min_temp_1),
    min_temp_2_l = log1p(min_temp_2),
    max_temp_1_l = log1p(max_temp_1),
    max_temp_2_l = log1p(max_temp_2)
  )
```

### heatmap_03

```{r}
climate_land_abund_03_500 <- climate_land_abund_03_500 %>%
  mutate(
    arable_500_l = log1p(arable_500),
    MAT_l = log1p(MAT)
  )

plot_03_500_dat_hull <- climate_land_abund_03_500 %>%
  slice(chull(arable_500_l, MAT_l))

plot_03_500_dat_hull <- plot_03_500_dat_hull %>%
  dplyr::select(arable_500_l, MAT_l)

plot_03_500_dat_hull_sf <- plot_03_500_dat_hull %>%
  st_as_sf(coords = c("arable_500_l", "MAT_l")) %>%
  summarise() %>%
  st_cast("POLYGON") %>%
  st_convex_hull()

plot_03_500_dat_xy <-
  with(climate_land_abund_03_500,
       expand.grid(
         arable_500_l = seq(min(arable_500_l),
                        max(arable_500_l),
                        len = 400),
         MAT_l = seq(min(MAT_l),
                        max(MAT_l),
                        len = 400)
       ))

plot_03_500_dat_xy_sf = st_as_sf(
  plot_03_500_dat_xy,
  coords = c("arable_500_l", "MAT_l"))

plot_03_crop <-
  st_intersection(
    plot_03_500_dat_xy_sf,
    plot_03_500_dat_hull_sf) %>%
  st_coordinates() %>%
  as.data.frame() %>%
  rename(arable_500_l = X, MAT_l = Y)

plot_03_crop <- plot_03_crop %>%
  mutate(
    arable_500 = (expm1(arable_500_l)),
    MAT = (expm1(MAT_l))
  ) %>%
  poly_add_columns(arable_500, degree = 2, prefix = "arable_") %>%
  poly_add_columns(MAT, degree = 2, prefix = "MAT_") %>%
  mutate(
    arable_1_l = log1p(arable_1),
    arable_2_l = log1p(arable_2),
    MAT_1_l = log1p(MAT_1),
    MAT_2_l = log1p(MAT_2)
  )

mod_03 <- lmer(
  fg_03_l ~
    arable_1_l + MAT_1_l +
    arable_2_l + MAT_2_l +
    (1 | StudyID_yr) +
    (1 | StudyID_yr:Sampling_method:Block),
  data = climate_land_abund_03_500
)

plot_03_crop$fg_03_l <-
  c(predict(mod_03, newdata = plot_03_crop, se = F, re.form = NA))

heatmap_03 <- ggplot() +
  geom_raster(data = plot_03_crop,
              aes(x = arable_500_l,
                  y = MAT_l,
                  fill = fg_03_l)) +
  geom_contour(
    data = plot_03_crop,
    aes(x = arable_500_l,
        y = MAT_l,
        z = fg_03_l),
    color = 'white',
    alpha = 0.5
  ) +
  scale_fill_viridis_c(
    option = "plasma",
    alpha = 1,
    breaks = c(2.3, 2.6, 2.9, 3.2)
    ) +
  scale_y_continuous(
    breaks = c(
      log1p(7 + 273.15), 
      log1p(10 + 273.15), 
      log1p(13 + 273.15), 
      log1p(16 + 273.15)),
    labels = c(7, 10, 13, 16)
    ) +
  scale_x_continuous(
    breaks = c(log1p(0), log1p(5), log1p(20), log1p(40), log1p(60), log1p(80)),
    labels = c(0, 5, 20, 40, 60, 80)
    ) +
  theme_classic() +
  theme(
    aspect.ratio = 1,
    # plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    legend.text = element_text(size = 7),
    legend.position = "right",
    legend.title = element_blank(),
    legend.key.width = unit(0.25, "cm"),
    legend.key.height = unit(0.25, "cm"),
    legend.box.spacing = unit(0.25, "pt"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0,0,0,0), "cm")
  ) +
  labs(
    fill = "Abundance",
       x = "Arable (%) in 0.5 km",
       y = "MAT (°C)")
heatmap_03
```

## Diet specialist pollinators

Data frame:
```{r}
climate_land_abund_06_500 <-
  climate_land_abund %>%
  filter(Pollinator_study == 1) %>%
  dplyr::select(
    ts_poll_spec_flight_noncrop_abund_scaled,
    semi_500,
    edge_500,
    arable_500,
    TAP,
    MAT,
    min_temp,
    max_temp,
    StudyID_yr,
    Sampling_method,
    Block,
    Latitude,
    Longitude
  ) %>%
  ungroup() %>%
  na.omit() %>%
  poly_add_columns(semi_500, degree = 2, prefix = "semi_") %>%
  poly_add_columns(edge_500, degree = 2, prefix = "edge_") %>%
  poly_add_columns(arable_500, degree = 2, prefix = "arable_") %>%
  poly_add_columns(TAP, degree = 2, prefix = "TAP_") %>%
  poly_add_columns(MAT, degree = 2, prefix = "MAT_") %>%
  poly_add_columns(min_temp, degree = 2, prefix = "min_temp_") %>%
  poly_add_columns(max_temp, degree = 2, prefix = "max_temp_") %>%
  mutate(
    ts_06_l = log1p(ts_poll_spec_flight_noncrop_abund_scaled),
    semi_1_l = log1p(semi_1),
    semi_2_l = log1p(semi_2),
    edge_1_l = log1p(edge_1),
    edge_2_l = log1p(edge_2),
    arable_1_l = log1p(arable_1),
    arable_2_l = log1p(arable_2),
    TAP_1_l = log1p(TAP_1),
    TAP_2_l = log1p(TAP_2),
    MAT_1_l = log1p(MAT_1),
    MAT_2_l = log1p(MAT_2),
    min_temp_1_l = log1p(min_temp_1),
    min_temp_2_l = log1p(min_temp_2),
    max_temp_1_l = log1p(max_temp_1),
    max_temp_2_l = log1p(max_temp_2)
  )
```

### heatmap_06_a

```{r}
climate_land_abund_06_500 <- climate_land_abund_06_500 %>%
  mutate(
    semi_500_l = log1p(semi_500),
    MAT_l = log1p(MAT)
  )

plot_06_500_dat_hull <- climate_land_abund_06_500 %>%
  slice(chull(semi_500_l, MAT_l))

plot_06_500_dat_hull <- plot_06_500_dat_hull %>%
  dplyr::select(semi_500_l, MAT_l)

plot_06_500_dat_hull_sf <- plot_06_500_dat_hull %>%
  st_as_sf(coords = c("semi_500_l", "MAT_l")) %>%
  summarise() %>%
  st_cast("POLYGON") %>%
  st_convex_hull()

plot_06_500_dat_xy <-
  with(climate_land_abund_06_500,
       expand.grid(
         semi_500_l = seq(min(semi_500_l),
                        max(semi_500_l),
                        len = 400),
         MAT_l = seq(min(MAT_l),
                        max(MAT_l),
                        len = 400)
       ))

plot_06_500_dat_xy_sf = st_as_sf(
  plot_06_500_dat_xy,
  coords = c("semi_500_l", "MAT_l"))

plot_06_crop <-
  st_intersection(
    plot_06_500_dat_xy_sf,
    plot_06_500_dat_hull_sf) %>%
  st_coordinates() %>%
  as.data.frame() %>%
  rename(semi_500_l = X, MAT_l = Y)

plot_06_crop <- plot_06_crop %>%
  mutate(
    semi_500 = (expm1(semi_500_l)),
    MAT = (expm1(MAT_l))
  ) %>%
  poly_add_columns(semi_500, degree = 2, prefix = "semi_") %>%
  poly_add_columns(MAT, degree = 2, prefix = "MAT_") %>%
  mutate(
    semi_1_l = log1p(semi_1),
    semi_2_l = log1p(semi_2),
    MAT_1_l = log1p(MAT_1),
    MAT_2_l = log1p(MAT_2)
  )

mod_06 <- lmer(
  ts_06_l ~
    semi_1_l * MAT_1_l +
    semi_1_l + MAT_1_l +
    semi_2_l + MAT_2_l +
    (1 | StudyID_yr) +
    (1 | StudyID_yr:Sampling_method:Block),
  data = climate_land_abund_06_500
)

plot_06_crop$ts_06_l <-
  c(predict(mod_06, newdata = plot_06_crop, se = F, re.form = NA))

heatmap_06_a <- ggplot() +
  geom_raster(data = plot_06_crop,
              aes(x = semi_500_l,
                  y = MAT_l,
                  fill = ts_06_l)) +
  geom_contour(
    data = plot_06_crop,
    aes(x = semi_500_l,
        y = MAT_l,
        z = ts_06_l),
    color = 'white',
    alpha = 0.5
  ) +
  scale_fill_viridis_c(
    option = "plasma",
    alpha = 1,
    breaks = c(0.6, 0.8, 1.0, 1.2)
    ) +
  scale_y_continuous(
    breaks = c(
      log1p(7 + 273.15), 
      log1p(10 + 273.15), 
      log1p(13 + 273.15), 
      log1p(16 + 273.15)),
    labels = c(7, 10, 13, 16)
    ) +
  scale_x_continuous(
    breaks = c(log1p(0), log1p(2), log1p(10), log1p(30), log1p(80)),
    labels = c(0, 2, 10, 30, 80)
    ) +
  theme_classic() +
  theme(
    aspect.ratio = 1,
    # plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    legend.text = element_text(size = 7),
    legend.position = "right",
    legend.title = element_blank(),
    legend.key.width = unit(0.25, "cm"),
    legend.key.height = unit(0.25, "cm"),
    legend.box.spacing = unit(0.25, "pt"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0,0,0,0), "cm")
  ) +
  labs(
    fill = "Abundance",
       x = "SNH (%) in 0.5 km",
       y = "MAT (°C)")
heatmap_06_a
```

### heatmap_06_b

```{r}
climate_land_abund_06_500 <- climate_land_abund_06_500 %>%
  mutate(
    semi_500_l = log1p(semi_500),
    max_temp_l = log1p(max_temp)
  )

plot_06_500_dat_hull <- climate_land_abund_06_500 %>%
  slice(chull(semi_500_l, max_temp_l))

plot_06_500_dat_hull <- plot_06_500_dat_hull %>%
  dplyr::select(semi_500_l, max_temp_l)

plot_06_500_dat_hull_sf <- plot_06_500_dat_hull %>%
  st_as_sf(coords = c("semi_500_l", "max_temp_l")) %>%
  summarise() %>%
  st_cast("POLYGON") %>%
  st_convex_hull()

plot_06_500_dat_xy <-
  with(climate_land_abund_06_500,
       expand.grid(
         semi_500_l = seq(min(semi_500_l),
                        max(semi_500_l),
                        len = 400),
         max_temp_l = seq(min(max_temp_l),
                        max(max_temp_l),
                        len = 400)
       ))

plot_06_500_dat_xy_sf = st_as_sf(
  plot_06_500_dat_xy,
  coords = c("semi_500_l", "max_temp_l"))

plot_06_crop <-
  st_intersection(
    plot_06_500_dat_xy_sf,
    plot_06_500_dat_hull_sf) %>%
  st_coordinates() %>%
  as.data.frame() %>%
  rename(semi_500_l = X, max_temp_l = Y)

plot_06_crop <- plot_06_crop %>%
  mutate(
    semi_500 = (expm1(semi_500_l)),
    max_temp = (expm1(max_temp_l))
  ) %>%
  poly_add_columns(semi_500, degree = 2, prefix = "semi_") %>%
  poly_add_columns(max_temp, degree = 2, prefix = "max_temp_") %>%
  mutate(
    semi_1_l = log1p(semi_1),
    semi_2_l = log1p(semi_2),
    max_temp_1_l = log1p(max_temp_1),
    max_temp_2_l = log1p(max_temp_2)
  )

mod_06 <- lmer(
  ts_06_l ~
    semi_1_l * max_temp_1_l +
    semi_1_l + max_temp_1_l +
    semi_2_l + max_temp_2_l +
    (1 | StudyID_yr) +
    (1 | StudyID_yr:Sampling_method:Block),
  data = climate_land_abund_06_500
)

plot_06_crop$ts_06_l <-
  c(predict(mod_06, newdata = plot_06_crop, se = F, re.form = NA))

heatmap_06_b <- ggplot() +
  geom_raster(data = plot_06_crop,
              aes(x = semi_500_l,
                  y = max_temp_l,
                  fill = ts_06_l)) +
  geom_contour(
    data = plot_06_crop,
    aes(x = semi_500_l,
        y = max_temp_l,
        z = ts_06_l),
    color = 'white',
    alpha = 0.5
  ) +
  scale_fill_viridis_c(
    option = "plasma",
    alpha = 1,
    breaks = c(0.6, 0.8, 1.0, 1.2)
    ) +
  scale_y_continuous(
    breaks = c(
      log1p(16 + 273.15),
      log1p(20 + 273.15),
      log1p(24 + 273.15),
      log1p(28 + 273.15)),
    labels = c(16, 20, 24, 28)
    ) +
  scale_x_continuous(
    breaks = c(log1p(0), log1p(2), log1p(10), log1p(30), log1p(80)),
    labels = c(0, 2, 10, 30, 80)
    ) +
  theme_classic() +
  theme(
    aspect.ratio = 1,
    # plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    legend.text = element_text(size = 7),
    legend.position = "right",
    legend.title = element_blank(),
    legend.key.width = unit(0.25, "cm"),
    legend.key.height = unit(0.25, "cm"),
    legend.box.spacing = unit(0.25, "pt"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0,0,0,0), "cm")
  ) +
  labs(
    fill = "Abundance",
       x = "SNH (%) in 0.5 km",
       y = "maxT (°C)")
heatmap_06_b
```

## Habitat specialist pests

Data frame:
```{r}
climate_land_abund_08_500 <-
  climate_land_abund %>%
  filter(Pest_study == 1) %>%
  dplyr::select(
    ts_pest_spec_flightwind_noncrop_abund_scaled,
    semi_500,
    edge_500,
    arable_500,
    TAP,
    MAT,
    min_temp,
    max_temp,
    StudyID_yr,
    Sampling_method,
    Block,
    Latitude,
    Longitude
  ) %>%
  ungroup() %>%
  na.omit() %>%
  poly_add_columns(semi_500, degree = 2, prefix = "semi_") %>%
  poly_add_columns(edge_500, degree = 2, prefix = "edge_") %>%
  poly_add_columns(arable_500, degree = 2, prefix = "arable_") %>%
  poly_add_columns(TAP, degree = 2, prefix = "TAP_") %>%
  poly_add_columns(MAT, degree = 2, prefix = "MAT_") %>%
  poly_add_columns(min_temp, degree = 2, prefix = "min_temp_") %>%
  poly_add_columns(max_temp, degree = 2, prefix = "max_temp_") %>%
  mutate(
    ts_08_l = log1p(ts_pest_spec_flightwind_noncrop_abund_scaled),
    semi_1_l = log1p(semi_1),
    semi_2_l = log1p(semi_2),
    edge_1_l = log1p(edge_1),
    edge_2_l = log1p(edge_2),
    arable_1_l = log1p(arable_1),
    arable_2_l = log1p(arable_2),
    TAP_1_l = log1p(TAP_1),
    TAP_2_l = log1p(TAP_2),
    MAT_1_l = log1p(MAT_1),
    MAT_2_l = log1p(MAT_2),
    min_temp_1_l = log1p(min_temp_1),
    min_temp_2_l = log1p(min_temp_2),
    max_temp_1_l = log1p(max_temp_1),
    max_temp_2_l = log1p(max_temp_2)
  )
```

### heatmap_08

```{r}
climate_land_abund_08_500 <- climate_land_abund_08_500 %>%
  mutate(
    semi_500_l = log1p(semi_500),
    min_temp_l = log1p(min_temp)
  )

plot_08_500_dat_hull <- climate_land_abund_08_500 %>%
  slice(chull(semi_500_l, min_temp_l))

plot_08_500_dat_hull <- plot_08_500_dat_hull %>%
  dplyr::select(semi_500_l, min_temp_l)

plot_08_500_dat_hull_sf <- plot_08_500_dat_hull %>%
  st_as_sf(coords = c("semi_500_l", "min_temp_l")) %>%
  summarise() %>%
  st_cast("POLYGON") %>%
  st_convex_hull()

plot_08_500_dat_xy <-
  with(climate_land_abund_08_500,
       expand.grid(
         semi_500_l = seq(min(semi_500_l),
                        max(semi_500_l),
                        len = 400),
         min_temp_l = seq(min(min_temp_l),
                        max(min_temp_l),
                        len = 400)
       ))

plot_08_500_dat_xy_sf = st_as_sf(
  plot_08_500_dat_xy,
  coords = c("semi_500_l", "min_temp_l"))

plot_08_crop <-
  st_intersection(
    plot_08_500_dat_xy_sf,
    plot_08_500_dat_hull_sf) %>%
  st_coordinates() %>%
  as.data.frame() %>%
  rename(semi_500_l = X, min_temp_l = Y)

plot_08_crop <- plot_08_crop %>%
  mutate(
    semi_500 = (expm1(semi_500_l)),
    min_temp = (expm1(min_temp_l))
  ) %>%
  poly_add_columns(semi_500, degree = 2, prefix = "semi_") %>%
  poly_add_columns(min_temp, degree = 2, prefix = "min_temp_") %>%
  mutate(
    semi_1_l = log1p(semi_1),
    semi_2_l = log1p(semi_2),
    min_temp_1_l = log1p(min_temp_1),
    min_temp_2_l = log1p(min_temp_2)
  )

mod_08 <- lmer(
  ts_08_l ~
    semi_1_l * min_temp_2_l +
    semi_1_l + min_temp_1_l +
    semi_2_l + min_temp_2_l +
    (1 | StudyID_yr) +
    (1 | StudyID_yr:Sampling_method:Block),
  data = climate_land_abund_08_500
)

plot_08_crop$ts_08_l <-
  c(predict(mod_08, newdata = plot_08_crop, se = F, re.form = NA))

heatmap_08 <- ggplot() +
  geom_raster(data = plot_08_crop,
              aes(x = semi_500_l,
                  y = min_temp_l,
                  fill = ts_08_l)) +
  geom_contour(
    data = plot_08_crop,
    aes(x = semi_500_l,
        y = min_temp_l,
        z = ts_08_l),
    color = 'white',
    alpha = 0.5
  ) +
  scale_fill_viridis_c(
    option = "plasma",
    alpha = 1,
    breaks = c(1.0, 1.5, 2.0)
    ) +
  scale_y_continuous(
    breaks = c(
      log1p(-3 + 273.15),
      log1p(0 + 273.15),
      log1p(3 + 273.15),
      log1p(6 + 273.15)),
    labels = c(-3, 0, 3, 6)
  ) +
  scale_x_continuous(
    breaks = c(log1p(0), log1p(2), log1p(10), log1p(30), log1p(80)),
    labels = c(0, 2, 10, 30, 80)
    ) +
  theme_classic() +
  theme(
    aspect.ratio = 1,
    # plot.title = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 8),
    legend.text = element_text(size = 7),
    legend.position = "right",
    legend.title = element_blank(),
    legend.key.width = unit(0.25, "cm"),
    legend.key.height = unit(0.25, "cm"),
    legend.box.spacing = unit(0.25, "pt"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = unit(c(0,0,0,0), "cm")
  ) +
  labs(
    fill = "Abundance",
       x = "SNH (%) in 0.5 km",
       y = "minT (°C)")
heatmap_08
```


# Figure S1

```{r}
climate_land_abund_cor1_dat <- climate_land_abund %>%
  select(
    semi_100,
    semi_250,
    semi_500,
    semi_1000,
    semi_2000,
    semi_3000,
    edge_100,
    edge_250,
    edge_500,
    edge_1000,
    edge_2000,
    edge_3000,
    arable_100,
    arable_250,
    arable_500,
    arable_1000,
    arable_2000,
    arable_3000
  ) %>%
  na.omit()
```

```{r}
cor_1 <- cor(climate_land_abund_cor1_dat)
cor_1
library(corrplot)
corrplot(cor_1)
```


# Figure S2

```{r}
climate_land_abund_cor2_dat <- climate_land_abund %>%
  select(
    min_precip,
    max_precip,
    TAP,
    min_temp,
    max_temp,
    MAT
  )

cor_2 <- cor(climate_land_abund_cor2_dat)
cor_2
library(corrplot)
corrplot(cor_2)
```



